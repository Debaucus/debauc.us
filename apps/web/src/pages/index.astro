---
import { db } from "../lib/db";
import { posts } from "../lib/schema";
import { desc, eq } from "drizzle-orm";
import Layout from "../layouts/Layout.astro";

const allPosts = await db.query.posts.findMany({
  where: eq(posts.status, "published"),
  orderBy: [desc(posts.publishedDate)],
  with: {
    coverImage: true,
    authorsLink: {
      with: {
        author: true,
      },
    },
    categoriesLink: {
      with: {
        category: true,
      },
    },
  },
});

const activeProjects = allPosts.filter((post: any) =>
  post.categoriesLink.some((link: any) => link.category?.title === "Active"),
);

const closedSoldProjects = allPosts.filter((post: any) =>
  post.categoriesLink.some((link: any) => link.category?.title === "Inactive"),
);

import { getCMSUrl } from "../lib/cms";

const getImageUrl = (media: any) => getCMSUrl(media?.url);

const schema = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  name: "Debauc.us",
  url: Astro.site,
  description:
    "Full Stack Developer Log - Documenting whatever crosses my mind, from projects to random tidbits.",
};
---

<Layout
  title="Debauc.us | Blog"
  description="Full Stack Developer Log - Documenting whatever crosses my mind, from projects to random tidbits."
>
  <script type="application/ld+json" set:html={JSON.stringify(schema)} />
  <main class="border-b border-zinc-800">
    <!-- Hero Block -->
    <div
      class="grid grid-cols-1 md:grid-cols-4 border-b border-zinc-800 min-h-[60vh]"
    >
      <div
        class="p-8 md:col-span-3 border-r border-zinc-800 flex flex-col justify-end"
      >
        <h1
          class="text-6xl md:text-9xl font-bold uppercase tracking-tighter text-zinc-100 font-mono leading-[0.85] mb-8"
        >
          Make it<br />
          <span class="text-zinc-500">Work</span><br />
          Make it <br /><span class="text-zinc-500">Better</span>
        </h1>
        <p
          class="text-zinc-500 font-mono text-sm max-w-xl leading-relaxed border-l border-emerald-500/50 pl-4 py-1"
        >
          Documenting whatever crosses my mind, to the project I'm working on
          currently, to random tid bits and useful infomation to reference back
          to.
        </p>
      </div>
      <div class="hidden md:flex flex-col">
        <div
          class="flex-1 p-4 border-b border-zinc-800 flex items-center justify-center bg-zinc-900/10"
        >
          <div class="text-center">
            <span class="block text-4xl font-bold text-zinc-100"
              >{activeProjects.length}</span
            >
            <span class="text-[10px] uppercase text-zinc-500 tracking-widest"
              >Active Projects</span
            >
          </div>
        </div>
        <div class="flex-1 bg-zinc-900/10 grid grid-cols-2">
          <div
            class="flex flex-col items-center justify-center p-4 border-r border-zinc-800"
          >
            <span class="block text-4xl font-bold text-zinc-100"
              >{allPosts.length}</span
            >
            <span class="text-[10px] uppercase text-zinc-500 tracking-widest"
              >Total Posts</span
            >
          </div>
          <div class="flex flex-col items-center justify-center p-4">
            <span class="block text-4xl font-bold text-zinc-100"
              >{closedSoldProjects.length}</span
            >
            <span
              class="text-[10px] uppercase text-zinc-500 tracking-widest text-center"
              >Closed / Sold Projects</span
            >
          </div>
        </div>
      </div>
    </div>

    <!-- Toolbar -->
    <div
      class="flex border-b border-zinc-800 bg-zinc-950/80 backdrop-blur-md text-xs font-mono font-medium text-zinc-500 sticky top-[61px] z-30"
    >
      <div class="px-4 py-2 border-r border-zinc-800 w-16 text-center">#</div>
      <div class="px-4 py-2 border-r border-zinc-800 flex-1">Project Name</div>
      <div class="hidden md:block px-4 py-2 border-r border-zinc-800 w-48">
        Date
      </div>
      <div class="hidden lg:block px-4 py-2 border-r border-zinc-800 w-64">
        Tags
      </div>
    </div>

    <!-- List View -->
    <div class="divide-y divide-zinc-800">
      {
        allPosts
          .filter((post: any) => post.slug)
          .map((post: any, index: number) => {
            const categories = post.categoriesLink
              .map((link: any) => link.category)
              .filter(Boolean);
            const coverUrl = getImageUrl(post.coverImage);

            return (
              <article class="group relative transition-colors duration-300">
                <a
                  href={`/${post.slug}`}
                  class="flex flex-col md:flex-row items-stretch min-h-[100px] z-10 relative"
                >
                  {/* Active Line Indicator */}
                  <div class="absolute inset-0 border border-transparent group-hover:border-zinc-700 pointer-events-none transition-all duration-300 z-20 mix-blend-screen" />
                  <div class="absolute left-0 top-0 bottom-0 w-[2px] bg-transparent group-hover:bg-emerald-500 transition-colors duration-200" />

                  {/* ID Column */}
                  <div class="p-4 md:w-16 border-b md:border-b-0 md:border-r border-zinc-800 font-mono text-zinc-500 text-xs flex items-center justify-center group-hover:text-zinc-300 transition-colors">
                    {String(index + 1).padStart(3, "0")}
                  </div>

                  {/* Main Content */}
                  <div class="flex-1 p-4 md:p-6 md:border-r border-zinc-800 flex flex-col justify-center relative overflow-hidden">
                    <h2 class="text-xl md:text-3xl font-bold text-zinc-200 group-hover:text-white transition-colors uppercase tracking-tighter mb-2">
                      {post.title}
                    </h2>
                    {post.excerpt && (
                      <p class="text-zinc-500 text-sm line-clamp-1 font-mono group-hover:text-zinc-400 transition-colors">
                        {post.excerpt}
                      </p>
                    )}
                  </div>

                  {/* Date */}
                  <div class="hidden md:flex w-48 border-r border-zinc-800 items-center px-4 font-mono text-xs text-zinc-500 group-hover:text-zinc-400 transition-colors">
                    {post.publishedDate
                      ? new Date(post.publishedDate).toISOString().split("T")[0]
                      : "Draft"}
                  </div>

                  {/* Tags */}
                  <div class="hidden lg:flex w-64 border-r border-zinc-800 items-center px-4 gap-2 flex-wrap content-center">
                    {categories.map((cat: any) => (
                      <span class="text-[10px] uppercase border border-zinc-800 px-1 py-0.5 text-zinc-500 rounded-sm group-hover:border-zinc-500 group-hover:text-zinc-300 transition-colors">
                        {cat.title}
                      </span>
                    ))}
                  </div>
                </a>
              </article>
            );
          })
      }
    </div>
  </main>
</Layout>
