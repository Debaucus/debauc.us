---
import { db } from "../lib/db";
import { posts } from "../lib/schema";
import { desc, eq } from "drizzle-orm";
import Layout from "../layouts/Layout.astro";

const allPosts = await db.query.posts.findMany({
  where: eq(posts.status, "published"),
  orderBy: [desc(posts.publishedDate)],
  with: {
    coverImage: true,
    authorsLink: {
      with: {
        author: true,
      },
    },
    categoriesLink: {
      with: {
        category: true,
      },
    },
  },
});

import { getCMSUrl } from "../lib/cms";

const getImageUrl = (media: any) => getCMSUrl(media?.url);
---

<Layout title="Debauc.us | Blog">
  <main class="border-b border-zinc-800">
    <!-- Hero Block -->
    <div class="grid grid-cols-1 md:grid-cols-4 border-b border-zinc-800">
      <div class="p-8 md:col-span-3 border-r border-zinc-800">
        <h1
          class="text-4xl md:text-6xl font-bold uppercase tracking-tighter text-zinc-100 mb-6 font-mono leading-none"
        >
          Full_Stack<br /><span class="text-zinc-600">Developer</span>
        </h1>
        <p
          class="text-zinc-400 font-mono text-sm max-w-xl leading-relaxed border-l-2 border-emerald-500 pl-4 py-1"
        >
          Building and documenting my journey in engineering & design. <br />
          15 projects and counting.
        </p>
      </div>
      <div class="hidden md:flex flex-col">
        <div
          class="flex-1 p-4 border-b border-zinc-800 flex items-center justify-center bg-zinc-900/30"
        >
          <div class="text-center">
            <span class="block text-4xl font-bold text-zinc-100"
              >{allPosts.length}</span
            >
            <span class="text-[10px] uppercase text-zinc-500 tracking-widest"
              >Posts</span
            >
          </div>
        </div>
        <div class="flex-1 p-4 flex items-center justify-center bg-zinc-900/10">
          <!-- Placeholder for potential future small infographic or empty space -->
        </div>
      </div>
    </div>

    <!-- Toolbar -->
    <div
      class="flex border-b border-zinc-800 bg-zinc-900/50 text-xs font-mono font-medium text-zinc-500 sticky top-[61px] z-30"
    >
      <div class="px-4 py-2 border-r border-zinc-800 w-16 text-center">#</div>
      <div class="px-4 py-2 border-r border-zinc-800 flex-1">Project Name</div>
      <div class="hidden md:block px-4 py-2 border-r border-zinc-800 w-48">
        Date
      </div>
      <div class="hidden lg:block px-4 py-2 border-r border-zinc-800 w-64">
        Tags
      </div>
      <div class="px-4 py-2 w-24 text-center">Link</div>
    </div>

    <!-- List View -->
    <div class="divide-y divide-zinc-800">
      {
        allPosts
          .filter((post: any) => post.slug)
          .map((post: any, index: number) => {
            const categories = post.categoriesLink
              .map((link: any) => link.category)
              .filter(Boolean);
            const coverUrl = getImageUrl(post.coverImage);

            return (
              <article class="group hover:bg-zinc-900/40 transition-colors">
                <a
                  href={`/${post.slug}`}
                  class="flex flex-col md:flex-row items-stretch min-h-[100px]"
                >
                  {/* ID Column */}
                  <div class="p-4 md:w-16 border-b md:border-b-0 md:border-r border-zinc-800 font-mono text-zinc-600 text-xs flex items-center justify-center">
                    {String(index + 1).padStart(2, "0")}
                  </div>

                  {/* Main Content */}
                  <div class="flex-1 p-4 md:p-6 md:border-r border-zinc-800 flex flex-col justify-center relative overflow-hidden">
                    <h2 class="text-xl md:text-2xl font-bold text-zinc-200 group-hover:text-emerald-400 transition-colors uppercase tracking-tight mb-2">
                      {post.title}
                    </h2>
                    {post.excerpt && (
                      <p class="text-zinc-500 text-sm line-clamp-1 font-mono">
                        {post.excerpt}
                      </p>
                    )}
                  </div>

                  {/* Date */}
                  <div class="hidden md:flex w-48 border-r border-zinc-800 items-center px-4 font-mono text-xs text-zinc-500">
                    {post.publishedDate
                      ? new Date(post.publishedDate).toISOString().split("T")[0]
                      : "Draft"}
                  </div>

                  {/* Tags */}
                  <div class="hidden lg:flex w-64 border-r border-zinc-800 items-center px-4 gap-2 flex-wrap content-center">
                    {categories.map((cat: any) => (
                      <span class="text-[10px] uppercase border border-zinc-700 px-1 py-0.5 text-zinc-400 rounded-sm">
                        {cat.title}
                      </span>
                    ))}
                  </div>

                  {/* Action */}
                  <div class="w-full md:w-24 flex items-center justify-center p-4 bg-zinc-950 group-hover:bg-zinc-900 transition-colors">
                    <span class="text-xs text-emerald-500 group-hover:underline">
                      View
                    </span>
                  </div>
                </a>
              </article>
            );
          })
      }
    </div>
  </main>
</Layout>
