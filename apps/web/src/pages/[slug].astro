---
import { db } from '../lib/db';
import { posts } from '../lib/schema';
import { eq } from 'drizzle-orm';
import Layout from '../layouts/Layout.astro';
import { serializeLexical } from '../lib/serializer';

export async function getStaticPaths() {
  const allPosts = await db.select({ slug: posts.slug }).from(posts);
  return allPosts.map((p: any) => ({
    params: { slug: p.slug },
  }));
}

const { slug } = Astro.params;
const post = await db.select().from(posts).where(eq(posts.slug, slug as string)).get();

if (!post) {
    return Astro.redirect('/404');
}

const contentHtml = await serializeLexical(post.content);
---

<Layout title={post.title}>
	<article class="container mx-auto px-4 py-8 max-w-3xl">
		<header class="mb-8">
            <h1 class="text-4xl font-bold mb-4">{post.title}</h1>
            <div class="text-gray-500">
                {new Date(post.createdAt).toLocaleDateString()}
            </div>
        </header>
        
        <div class="prose lg:prose-xl" set:html={contentHtml} />
	</article>
</Layout>
